%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% <TEI> generic (LaTeX names generated by Teinte) %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This template is inserted in a specific design
% It is XeLaTeX and otf fonts

\makeatletter % <@@@


\usepackage{blindtext} % generate text for testing
\usepackage{contour} % rounding words
\usepackage[nodayofweek]{datetime}
\usepackage{DejaVuSans} % font for symbols
\usepackage{enumitem} % <list>
\usepackage{etoolbox} % patch commands
\usepackage{fancyvrb}
\usepackage{fancyhdr}
\usepackage{fontspec} % XeLaTeX mandatory for fonts
\usepackage{footnote} % used to capture notes in minipage (ex: quote)
\usepackage{framed} % bordering correct with footnote hack
\usepackage{graphicx}
\usepackage{lettrine} % drop caps
\usepackage{lipsum} % generate text for testing
\usepackage[framemethod=tikz,]{mdframed} % maybe used for frame with footnotes inside
\usepackage{pdftexcmds} % needed for tests expressions
\usepackage{polyglossia} % non-break space french punct, bug Warning: "Failed to patch part"
\usepackage[%
  indentfirst=false,
  vskip=1em,
  noorphanfirst=true,
  noorphanafter=true,
  leftmargin=\parindent,
  rightmargin=0pt,
]{quoting}
\usepackage{ragged2e}
\usepackage{setspace}
\usepackage{tabularx} % <table>
\usepackage[explicit]{titlesec} % wear titles, !NO implicit
\usepackage{tikz} % ornaments
\usepackage{tocloft} % styling tocs
\usepackage[fit]{truncate} % used im runing titles
\usepackage{unicode-math}
\usepackage[normalem]{ulem} % breakable \uline, normalem is absolutely necessary to keep \emph
\usepackage{verse} % <l>
\usepackage{xcolor} % named colors
\usepackage{xparse} % @ifundefined
\XeTeXdefaultencoding "iso-8859-1" % bad encoding of xstring
\usepackage{xstring} % string tests
\XeTeXdefaultencoding "utf-8"
\PassOptionsToPackage{hyphens}{url} % before hyperref, which load url package
\usepackage{hyperref} % supposed to be the last one, :o) except for the ones to follow
\urlstyle{same} % after hyperref

% TOTEST
% \usepackage{hypcap} % links in caption ?
% \usepackage{marginnote}
% TESTED
% \usepackage{background} % doesn’t work with xetek
% \usepackage{bookmark} % prefers the hyperref hack \phantomsection
% \usepackage[color, leftbars]{changebar} % 2 cols doc, impossible to keep bar left
% \usepackage[utf8x]{inputenc} % inputenc package ignored with utf8 based engines
% \usepackage[sfdefault,medium]{inter} % no small caps
% \usepackage{firamath} % unavailable in Ubuntu 21-04
% \usepackage{flushend} % bad for last notes, supposed flush end of columns
% \usepackage[stable]{footmisc} % BAD for complex notes https://texfaq.org/FAQ-ftnsect
% \usepackage{helvet} % not for XeLaTeX
% \usepackage{multicol} % not compatible with too much packages (longtable, framed, memoir…)
% \usepackage{sectsty} % \chapterfont OBSOLETE
% \usepackage{soul} % \ul for underline, OBSOLETE with XeTeX
% \usepackage[breakable]{tcolorbox} % text styling gone, footnote hack not kept with breakable



% Metadata inserted by a program, from the TEI source, for title page and runing heads
%meta%
% Default metas
\newcommand{\colorprovide}[2]{\@ifundefinedcolor{#1}{\colorlet{#1}{#2}}{}}
\colorprovide{rubric}{red}
\colorprovide{silver}{Gray}
\@ifundefined{syms}{\newfontfamily\syms{DejaVu Sans}}{}
\newif\ifdev
\@ifundefined{elbibl}{% No meta defined, maybe dev mode
  \newcommand{\elbibl}{Titre court ?}
  \newcommand{\elbook}{Titre du livre source ?}
  \newcommand{\elabstract}{Résumé\par}
  \newcommand{\elurl}{http://oeuvres.github.io/elbook/2}
  \author{Éric Lœchien}
  \title{Un titre de test assez long pour vérifier le comportement d’une maquette}
  \date{1566}
  \devtrue
}{}
\let\eltitle\@title
\let\elauthor\@author
\let\eldate\@date


\defaultfontfeatures{
  % Mapping=tex-text, % no effect seen
  Scale=MatchLowercase,
  Ligatures={TeX,Common},
}

\@ifundefined{\columnseprulecolor}{%
    \patchcmd\@outputdblcol{% find
      \normalcolor\vrule
    }{% and replace by
      \columnseprulecolor\vrule
    }{% success
    }{% failure
      \@latex@warning{Patching \string\@outputdblcol\space failed}%
    }
}{}

\hypersetup{
  % pdftex, % no effect
  pdftitle={\elbibl},
  % pdfauthor={Your name here},
  % pdfsubject={Your subject here},
  % pdfkeywords={keyword1, keyword2},
  bookmarksnumbered=true,
  bookmarksopen=true,
  bookmarksopenlevel=1,
  pdfstartview=Fit,
  breaklinks=true, % avoid long links
  pdfpagemode=UseOutlines,    % pdf toc
  hyperfootnotes=true,
  colorlinks=false,
  pdfborder=0 0 0,
  % pdfpagelayout=TwoPageRight,
  % linktocpage=true, % NO, toc, link only on page no
}


% generic typo commands
\newcommand{\astermono}{\medskip\centerline{\color{rubric}\large\selectfont{\syms ✻}}\medskip\par}%
\newcommand{\astertri}{\medskip\par\centerline{\color{rubric}\large\selectfont{\syms ✻\,✻\,✻}}\medskip\par}%
\newcommand{\asterism}{\bigskip\par\noindent\parbox{\linewidth}{\centering\color{rubric}\large{\syms ✻}\\{\syms ✻}\hskip 0.75em{\syms ✻}}\bigskip\par}%

% lists
\newlength{\listmod}
\setlength{\listmod}{\parindent}
\setlist{
  itemindent=!,
  listparindent=\listmod,
  labelsep=0.2\listmod,
  parsep=0pt,
  % topsep=0.2em, % default topsep is best
}
\setlist[itemize]{
  label=—,
  leftmargin=0pt,
  labelindent=1.2em,
  labelwidth=0pt,
}
\setlist[enumerate]{
  label={\bf\color{rubric}\arabic*.},
  labelindent=0.8\listmod,
  leftmargin=\listmod,
  labelwidth=0pt,
}
\newlist{listalpha}{enumerate}{1}
\setlist[listalpha]{
  label={\bf\color{rubric}\alph*.},
  leftmargin=0pt,
  labelindent=0.8\listmod,
  labelwidth=0pt,
}
\newcommand{\listhead}[1]{\hspace{-1\listmod}\emph{#1}}

\renewcommand{\hrulefill}{%
  \leavevmode\leaders\hrule height 0.2pt\hfill\kern\z@}

% General typo
\DeclareTextFontCommand{\textlarge}{\large}
\DeclareTextFontCommand{\textsmall}{\small}


% commands, inlines
\newcommand{\anchor}[1]{\Hy@raisedlink{\hypertarget{#1}{}}} % link to top of an anchor (not baseline)
\newcommand\abbr{}
\newcommand{\autour}[1]{\tikz[baseline=(X.base)]\node [draw=rubric,thin,rectangle,inner sep=1.5pt, rounded corners=3pt] (X) {#1};}
\newcommand\corr{}
\newcommand{\ed}[1]{ {\color{silver}\sffamily\footnotesize (#1)} } % <milestone ed="1688"/>
\newcommand\expan{}
\newcommand\gap{}
\renewcommand{\LettrineFontHook}{\color{rubric}}
\newcommand{\initial}[2]{\lettrine[lines=2, loversize=0.3, lhang=0.3]{#1}{#2}}
\newcommand{\initialiv}[2]{%
  \let\oldLFH\LettrineFontHook
  % \renewcommand{\LettrineFontHook}{\color{rubric}\ttfamily}
  \IfSubStr{Q}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=-0.1, lraise=0.2]{\smash{#1}}{#2}
  }{\IfSubStr{É}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=-0, lraise=0]{\smash{#1}}{#2}
  }{\IfSubStr{ÀÂ}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=-0, lraise=0, slope=0.6em]{\smash{#1}}{#2}
  }{\IfSubStr{A}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=0.2, slope=0.6em]{\smash{#1}}{#2}
  }{\IfSubStr{V}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=0.2, slope=-0.5em]{\smash{#1}}{#2}
  }{
    \lettrine[lines=4, lhang=0.2, loversize=0.2]{\smash{#1}}{#2}
  }}}}}
  \let\LettrineFontHook\oldLFH
}
\newcommand{\labelchar}[1]{\textbf{\color{rubric} #1}}
\newcommand{\milestone}[1]{\autour{\footnotesize\color{rubric} #1}} % <milestone n="4"/>
\newcommand\name{}
\newcommand\orig{}
\newcommand\orgName{}
\newcommand\persName{}
\newcommand\placeName{}
\newcommand{\pn}[1]{{\sffamily\textbf{#1.}} } % <p n="3"/>
\newcommand\reg{}
% \newcommand\ref{} % already defined
\newcommand\sic{}
\def\mednobreak{\ifdim\lastskip<\medskipamount
  \removelastskip\nopagebreak\medskip\fi}
\def\bignobreak{\ifdim\lastskip<\bigskipamount
  \removelastskip\nopagebreak\bigskip\fi}

% commands, blocks
\newcommand{\byline}[1]{\bigskip{\RaggedLeft{#1}\par}\bigskip}
\newcommand{\bibl}[1]{{\RaggedLeft{#1}\par\bigskip}}
\newcommand{\biblitem}[1]{{\noindent\hangindent=\parindent   #1\par}}
\newcommand{\dateline}[1]{\medskip{\RaggedLeft{#1}\par}\bigskip}
\newcommand{\labelblock}[1]{\bigbreak{\color{rubric}\noindent\textbf{#1}\par}\bignobreak}
\newcommand{\salute}[1]{\bigbreak{#1}\par\medbreak}
\newcommand{\signed}[1]{\bigbreak\filbreak{\raggedleft #1\par}\medskip}

% environments for blocks (some may become commands)
\newenvironment{borderbox}{}{} % framing content
\newenvironment{citbibl}{\ifvmode\hfill\fi}{\ifvmode\par\fi }
\newenvironment{docAuthor}{\ifvmode\vskip4pt\fontsize{16pt}{18pt}\selectfont\fi\itshape}{\ifvmode\par\fi }
\newenvironment{docDate}{}{\ifvmode\par\fi }
\newenvironment{docImprint}{\vskip6pt}{\ifvmode\par\fi }
\newenvironment{docTitle}{\vskip6pt\bfseries\fontsize{18pt}{22pt}\selectfont}{\par }
\newenvironment{msHead}{\vskip6pt}{\par}
\newenvironment{msItem}{\vskip6pt}{\par}
\newenvironment{titlePart}{}{\par }


% environments for block containers
\newenvironment{argument}{\fontlight\parindent0pt}{\vskip1.5em}
\newenvironment{biblfree}{}{\ifvmode\par\fi }
\newenvironment{bibitemlist}[1]{%
  \list{\@biblabel{\@arabic\c@enumiv}}%
  {%
    \settowidth\labelwidth{\@biblabel{#1}}%
    \leftmargin\labelwidth
    \advance\leftmargin\labelsep
    \@openbib@code
    \usecounter{enumiv}%
    \let\p@enumiv\@empty
    \renewcommand\theenumiv{\@arabic\c@enumiv}%
  }
  \sloppy
  \clubpenalty4000
  \@clubpenalty \clubpenalty
  \widowpenalty4000%
  \sfcode`\.\@m
}%
{\def\@noitemerr
  {\@latex@warning{Empty `bibitemlist' environment}}%
\endlist}
\newenvironment{quoteblock}% may be used for ornaments
  {\begin{quoting}}
  {\end{quoting}}

% table () is preceded and finished by custom command
\newcommand{\tableopen}[1]{%
  \ifnum\strcmp{#1}{wide}=0{%
    \begin{center}
  }
  \else\ifnum\strcmp{#1}{long}=0{%
    \begin{center}
  }
  \else{%
    \begin{center}
  }
  \fi\fi
}
\newcommand{\tableclose}[1]{%
  \ifnum\strcmp{#1}{wide}=0{%
    \end{center}
  }
  \else\ifnum\strcmp{#1}{long}=0{%
    \end{center}
  }
  \else{%
    \end{center}
  }
  \fi\fi
}


% text structure
\newcommand\chapteropen{} % before chapter title
\newcommand\chaptercont{} % after title, argument, epigraph…
\newcommand\chapterclose{} % maybe useful for multicol settings
\setcounter{secnumdepth}{-2} % no counters for hierarchy titles
\setcounter{tocdepth}{5} % deep toc
\markright{\@title} % ???
\markboth{\@title}{\@author} % ???
\renewcommand\tableofcontents{\@starttoc{toc}}
% toclof format
% \renewcommand{\@tocrmarg}{0.1em} % Useless command?
% \renewcommand{\@pnumwidth}{0.5em} % {1.75em}
\renewcommand{\@cftmaketoctitle}{}
\setlength{\cftbeforesecskip}{\z@ \@plus.2\p@}
\renewcommand{\cftchapfont}{}
\renewcommand{\cftchapdotsep}{\cftdotsep}
\renewcommand{\cftchapleader}{\normalfont\cftdotfill{\cftchapdotsep}}
\renewcommand{\cftchappagefont}{\bfseries}
\setlength{\cftbeforechapskip}{0em \@plus\p@}
% \renewcommand{\cftsecfont}{\small\relax}
\renewcommand{\cftsecpagefont}{\normalfont}
% \renewcommand{\cftsubsecfont}{\small\relax}
\renewcommand{\cftsecdotsep}{\cftdotsep}
\renewcommand{\cftsecpagefont}{\normalfont}
\renewcommand{\cftsecleader}{\normalfont\cftdotfill{\cftsecdotsep}}
\setlength{\cftsecindent}{1em}
\setlength{\cftsubsecindent}{2em}
\setlength{\cftsubsubsecindent}{3em}
\setlength{\cftchapnumwidth}{1em}
\setlength{\cftsecnumwidth}{1em}
\setlength{\cftsubsecnumwidth}{1em}
\setlength{\cftsubsubsecnumwidth}{1em}

% footnotes
\newif\ifheading
\newcommand*{\fnmarkscale}{\ifheading 0.70 \else 1 \fi}
\renewcommand\footnoterule{\vspace*{0.3cm}\hrule height \arrayrulewidth width 3cm \vspace*{0.3cm}}
\setlength\footnotesep{1.5\footnotesep} % footnote separator
\renewcommand\@makefntext[1]{\parindent 1.5em \noindent \hb@xt@1.8em{\hss{\normalfont\@thefnmark . }}#1} % no superscipt in foot


% orphans and widows
\clubpenalty=9996
\widowpenalty=9999
\brokenpenalty=4991
\predisplaypenalty=10000
\postdisplaypenalty=1549
\displaywidowpenalty=1602
\hyphenpenalty=400
% Copied from Rahtz but not understood
\def\@pnumwidth{1.55em}
\def\@tocrmarg {2.55em}
\def\@dotsep{4.5}
\emergencystretch 3em
\hbadness=4000
\pretolerance=750
\tolerance=2000
\vbadness=4000
\def\Gin@extensions{.pdf,.png,.jpg,.mps,.tif}
% \renewcommand{\@cite}[1]{#1} % biblio

\makeatother % /@@@>
%%%%%%%%%%%%%%
% </TEI> end %
%%%%%%%%%%%%%%
